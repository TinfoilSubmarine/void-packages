# Template file for 'gaphor'
pkgname=gaphor
version=2.12.1
revision=1
build_style=python3-pep517
# these tests sporadically segmentation fault or fail on uninstalled package
# but succeed when run after installed on host
make_check_args="--ignore=gaphor/ui/tests/test_selftest.py
 --ignore=gaphor/ui/tests/test_main.py
 --ignore=gaphor/ui/tests/test_mainwindow.py
 --ignore=gaphor/ui/tests/test_statuswindow.py
 --ignore=gaphor/plugins/console/tests/test_console.py
 --ignore=gaphor/plugins/console/tests/test_consolewindow.py
 --ignore=gaphor/plugins/errorreports/tests/test_errorreport.py
 --deselect=tests/test_gaphorconvert.py::test_export_png"
make_install_target="gaphor-${version}-*-*-*.whl"
hostmakedepends="python3-poetry-core"
depends="python3-cairo python3-gobject python3-gaphas python3-generic
 python3-tinycss2 python3-jedi python3-darkdetect python3-better_exceptions"
checkdepends="python3-pytest python3-pytest-mock python3-hypothesis xvfb-run
 python3-Sphinx gtksourceview5 libadwaita hicolor-icon-theme unzip $depends"
short_desc="Simple modeling tool written in Python"
maintainer="Joel Beckmeyer <joel@beckmeyer.us>"
license="Apache-2.0"
homepage="https://gaphor.org"
changelog="https://raw.githubusercontent.com/gaphor/gaphor/main/NEWS"
distfiles="https://github.com/gaphor/gaphor/archive/${version}.tar.gz"
checksum=1f38c6c61d3bed54844cc31de1a18426b6a1c43b43a7d9d3d0f262df32aebc81
make_check_pre="xvfb-run"

pre_check() {
	# needs unpackaged python package xdoctest, see commit
	# 19ba9331955e3e0c41cc03b4e75dc2c22263bcaf in upstream
	vsed -e '/addopts/d' -i pyproject.toml
	unzip ${make_install_target} "*.dist-info/*"
}

post_install() {
	vinstall _packaging/appimage/org.gaphor.Gaphor.desktop 644 usr/share/applications
	vinstall _packaging/appimage/org.gaphor.Gaphor.png 644 usr/share/pixmaps
}
